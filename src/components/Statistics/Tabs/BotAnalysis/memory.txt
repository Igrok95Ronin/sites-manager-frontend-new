# Память сессии - Разработка функционала эталонных записей и анализа ботов

## Дата: 2025-08-18

## Основные реализованные функции:

### 1. BotAnalysis - Экспорт в CSV
- Добавлен функционал экспорта данных анализа ботов в CSV
- Endpoint: `/bot-analysis/export`
- Реализован диалог с настройками экспорта (выбор типов: боты, вероятные боты, подозрительные, люди)
- Правильная передача параметров включая limit (количество загруженных записей)
- Обработка ошибок при пустых результатах фильтрации

### 2. ReferenceHeaders - Новый компонент для эталонных записей
**Путь:** `src/components/Statistics/Tabs/ReferenceHeaders/ReferenceHeaders.js`

#### Основные возможности:
- Отображение эталонных записей в виде аккордеонов
- Расширенный поиск по полям (домен, IP, ключевое слово, устройство)
- Модальное окно для просмотра Headers и JS Data
- Отображение новых полей устройства:
  - DeviceName (название устройства)
  - DeviceModel (модель)
  - OS и OSVersion
  - Browser и BrowserVersion
  - DeviceCategory (mobile/tablet/desktop)
  - ScreenResolution
  - IsEmulator (флаг эмулятора)
  - Notes (примечания)

#### Редактирование эталонных записей:
- Endpoint: `PATCH /reference/details`
- Формат запроса:
```json
{
  "originalClickId": 150196,
  "deviceName": "iPhone 15 Pro",
  "deviceModel": "A3102",
  "os": "iOS",
  "osVersion": "17.2.1",
  "browser": "Safari",
  "browserVersion": "17.2",
  "deviceCategory": "mobile",
  "screenResolution": "1170x2532",
  "isEmulator": false,
  "notes": "Реальное устройство, тест от 15.08.2025"
}
```
- Все поля опциональны
- Обновление локального состояния после сохранения
- Визуальная обратная связь (сообщения об успехе/ошибке)

#### Управление статусом эталонной записи:
- Добавлен чекбокс "Эталонная запись" в форму редактирования
- По умолчанию включен (true)
- При снятии галочки:
  - Показывается предупреждение
  - Кнопка меняется на "Удалить из эталонных"
  - Запись удаляется через `/reference/update` с `isReference: false`
  - Запись исчезает из таблицы

### 3. Интеграция с основной таблицей
- Добавлена колонка IsReference с BookmarkIcon
- Чекбокс для отметки записей как эталонных
- Endpoint: `POST /reference/update`
- Формат: `{ id: number, isReference: boolean }`

### 4. Добавлен новый таб "Эталонные записи"
- 5-й таб в TabPanelProps
- Интегрирован компонент ReferenceHeaders

## Исправленные проблемы:

### 1. Sass deprecation warnings
- Проблема с Legacy JS API в sass-loader
- Частично решено добавлением sass-loader в devDependencies
- Полное решение требует обновления webpack конфигурации

### 2. Export endpoint 404
- Исправлена передача параметров limit
- Добавлена обработка пустых результатов фильтрации
- Backend возвращает 404 при отсутствии данных после фильтрации

### 3. React validateDOMNesting warnings
- Исправлено: h6 не может быть внутри h2
- Заменено на Typography variant="subtitle1" с fontWeight: 'bold'

### 4. ESLint warnings
- Удалены неиспользуемые импорты (DeleteIcon, FilterIcon, PhoneAndroidIcon)
- Закомментирована неиспользуемая функция handleRemoveReference

## API Endpoints используемые в проекте:

### Reference (Эталонные записи):
- `GET /reference/list` - получить список эталонных записей
- `POST /reference/update` - обновить статус IsReference
- `PATCH /reference/details` - обновить детали эталонной записи

### Bot Analysis:
- `GET /bot-analysis` - получить данные анализа
- `GET /bot-analysis/export` - экспортировать в CSV

## Структура файлов:
```
src/components/Statistics/Tabs/
├── BotAnalysis/
│   ├── BotAnalysis.js (экспорт CSV)
│   └── memory.txt (этот файл)
├── ReferenceHeaders/
│   ├── ReferenceHeaders.js (компонент эталонных записей)
│   └── ReferenceHeaders.scss (стили)
├── TableRowRender/
│   └── TableRowRender.js (чекбокс IsReference)
├── Columns/
│   └── Columns.js (колонка IsReference)
└── TabPanelProps/
    └── TabPanelProps.js (интеграция табов)
```

## Ключевые особенности реализации:
1. Использование Material-UI компонентов
2. React hooks (useState, useEffect, useCallback)
3. Axios для API запросов
4. JSONTree для отображения JSON данных
5. Локальное обновление состояния для мгновенной обратной связи
6. Обработка ошибок с информативными сообщениями

## Что осталось сделать:
- Полное решение Sass deprecation warnings (требует изменения webpack config)
- Backend пока не готов для некоторых функций (отмечено в коде)

## Изменения (16.08.2025, продолжение) - Исправления и улучшения эталонного анализа:

### Исправленные ошибки:
1. **TypeError с toFixed() на undefined:**
   - Добавлена проверка на undefined/null в formatProbability
   - Возвращает 'N/A' вместо ошибки

2. **Ошибка LinearProgress с цветом 'default':**
   - LinearProgress не отображается для NO_REFERENCE статуса
   - Добавлен fallback на 'primary' цвет

3. **Проблема отображения "N/A" вместо данных эталона:**
   - Реализована функция extractReferenceInfo для парсинга analysis_report
   - Извлекает ID эталона, название устройства, количество совпадений/расхождений

### Улучшения интерфейса:
1. **Вынесена информация об эталоне в заголовок аккордеона:**
   - Chip с названием эталона (например: "TECHNO POVA 6 Pro 5G")
   - Chip с процентом совпадения с цветовой индикацией:
     - Зеленый: ≥85% (хорошее совпадение)
     - Желтый: 60-84% (среднее совпадение)  
     - Красный: <60% (плохое совпадение)

2. **Поддержка разных форматов полей от backend:**
   - CamelCase: Domain, IP, CreatedAt
   - snake_case: domain, ip, created_at
   - Автоматическое определение формата

3. **Отображение специфичных данных эталонного анализа:**
   - Списки совпадений (зеленые алерты)
   - Списки расхождений (красные алерты)
   - Все проверенные параметры с весами
   - Информация о релевантных эталонах

4. **Обработка статуса NO_REFERENCE:**
   - Специальная иконка (HelpOutlineIcon)
   - Сообщение "Нет подходящих эталонов"
   - Отдельная карточка в статистике

### Функция extractReferenceInfo:
```javascript
// Парсит analysis_report и извлекает:
// - ID эталона (из паттерна "#150842")
// - Название устройства (из скобок)
// - Количество совпадений/расхождений
const extractReferenceInfo = (report) => {
  const refMatch = report.match(/эталоном #(\d+)\s*\(([^)]+)\)/);
  const statsMatch = report.match(/Расхождений:\s*(\d+),\s*Совпадений:\s*(\d+)/);
  return {
    id: refMatch?.[1],
    name: refMatch?.[2],
    differences: statsMatch?.[1],
    matches: statsMatch?.[2]
  };
};
```

### Статистика для эталонного анализа:
- Добавлено поле noReference в stats
- Показывается отдельная карточка "Без эталона" только при эталонном анализе
- Правильный подсчет всех статусов включая NO_REFERENCE

## Изменения (16.08.2025) - Анализ по эталонам:
1. **Добавлена кнопка "Анализ Эталон":**
   - Расположена рядом с кнопкой обычного анализа
   - Использует endpoint `/bot-analysis-reference`
   - Цвет secondary (фиолетовый) для визуального отличия

2. **Поддержка двух типов анализа:**
   - Эвристический (28 проверок) - обычная кнопка "Анализ"
   - По эталонам (сравнение с реальными устройствами) - кнопка "Анализ Эталон"
   - Состояние `analysisType` отслеживает текущий тип

3. **Обновлен экспорт:**
   - Автоматически выбирает правильный endpoint для экспорта
   - `/bot-analysis/export` для эвристического
   - `/bot-analysis-reference/export` для эталонного

4. **Индикация типа анализа:**
   - Chip с названием типа анализа в блоке статистики
   - Разные иконки для каждого типа
   - Цветовая дифференциация

5. **Endpoints эталонного анализа:**
   - `POST /bot-analysis-reference` - анализ
   - `POST /bot-analysis-reference/export` - экспорт в CSV

## Последние изменения (15.08.2025):
1. Реализовано полное редактирование эталонных записей
2. Добавлен чекбокс для управления статусом эталонной записи
3. Исправлены все ESLint и React warnings
4. Добавлена визуальная обратная связь при сохранении/удалении

## Изменения (16.08.2025) - Группировка по устройствам:
1. **Добавлена двухуровневая структура аккордеонов:**
   - Первый уровень - группы устройств (по DeviceName)
   - Второй уровень - отдельные записи внутри каждого устройства
   
2. **Новая функция группировки `groupDataByDevice`:**
   - Группирует записи по полю DeviceName
   - Если DeviceName отсутствует, создает имя из OS + Browser + Device
   - Сортирует группы по времени последнего добавления (новые сверху)
   
3. **Улучшенная визуализация:**
   - Группы устройств имеют увеличенную иконку и выделенный фон
   - Счетчик записей для каждого устройства
   - Отображение характеристик устройства (OS, Browser, разрешение)
   - Специальные иконки для TECHNO POVA (смартфон) и PC (компьютер)
   
4. **Новые состояния:**
   - `expandedDevices` - отслеживает развернутые группы устройств
   - `handleDeviceExpandChange` - обработчик для групп устройств
   
5. **Обновленные стили (ReferenceHeaders.scss):**
   - `.device-group-accordion` - стили для групп устройств с градиентом и тенью
   - `.device-item-accordion` - стили для вложенных записей
   - Визуальная иерархия через отступы и цвета

## Изменения (18.08.2025) - Добавление новых полей из main.js в таблицу Statistics:

### 1. Новые поля в main.js:
- **hardwareConcurrency** - количество логических процессоров
- **deviceMemory** - объем памяти устройства (максимум 8 ГБ из-за ограничений браузера)
- **clickCount** - количество кликов пользователя на странице
- **maxScrollY** - максимальная глубина скролла в пикселях
- **hadMouse** - использовалась ли мышь до скролла
- **hadTouch** - было ли касание до скролла
- **hasConnection** - есть ли Network Information API
- **hasMemory** - есть ли Performance Memory API
- **hasPlugins** - есть ли плагины в браузере
- **hasDeviceOrientationEvent** - есть ли поддержка гироскопа
- **isTouchCapable** - поддержка тач-событий

### 2. Решение проблемы с сохранением в БД:
**Проблема:** Backend не сохранял новое поле `behavior` в БД.

**Решение:** Вместо отдельного поля `behavior`, все данные теперь сохраняются в существующее поле `browserData` (JsData в БД):
```javascript
// В main.js данные добавляются в browserDataObj:
const browserDataWithBehavior = {
  ...browserDataObj,
  clickCount: clickCount,
  maxScrollY: maxScrollY,
  hadMouse: !!wasMouseBeforeScroll,
  hadTouch: !!wasTouchedBeforeScroll,
  hasConnection: !!navigator.connection,
  hasMemory: !!performance.memory,
  // и т.д.
};
```

### 3. Исправлена проблема отображения:
**Проблема:** Данные извлекались в `processedData`, но не доходили до TableRowRender.

**Решение:** 
- Строка 546: `rows={processedData}` вместо `rows={filteredData}`
- Строка 594: `rows={processedData}` вместо `rows={rows}`

### 4. Добавлены новые колонки в таблицу:
#### Поведенческие метрики:
- **hardwareConcurrency** - число (количество ядер)
- **deviceMemory** - число с "GB" (например, "8 GB")
- **clickCount** - количество кликов
- **maxScrollY** - глубина скролла с "px"
- **hadMouse/hadTouch** - галочка ✓ / крестик ✗

#### API флаги (для определения ботов):
- **hasConnection** ✓/✗
- **hasMemory** ✓/✗
- **hasPlugins** ✓/✗
- **hasDeviceOrientationEvent** ✓/✗
- **isTouchCapable** ✓/✗

### 5. Обновленные файлы:
- `main.js` - добавлены новые поля в browserData
- `Statistics.js` - извлечение новых полей из JsData
- `Columns.js` - добавлены новые колонки
- `TableRowRender.js` - обработка отображения новых полей

### 6. Важные замечания:
- **deviceMemory** всегда показывает максимум 8 ГБ (ограничение браузера для защиты приватности)
- Поля `clickCount`, `maxScrollY`, `hadMouse`, `hadTouch` будут заполнены только для НОВЫХ записей после обновления main.js на сайтах
- API флаги помогают определить ботов по подозрительным комбинациям (например, iPhone с hasPlugins=true)

### 7. Как определять ботов с помощью новых полей:
- **Подозрительные комбинации:**
  - iPhone/iPad с `hasPlugins = true` (на iOS нет плагинов)
  - Desktop с `isTouchCapable = true`, но `hadTouch = false`
  - Mobile с `hasDeviceOrientationEvent = false`
  - `clickCount = 0` при длительном `timeSpent`
  - `maxScrollY = 0` при просмотре длинной страницы

## Backend (Go) - эталонный анализ:
Файл `botanalysis_reference.go` содержит реализацию эталонного анализа:
- Сравнение по 8 параметрам с весами
- Определение статуса: HUMAN (≥85%), SUSPICIOUS (60-84%), BOT (<60%)
- Экспорт результатов в CSV
- Детальные отчеты о совпадениях/расхождениях